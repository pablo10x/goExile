<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spawner Registry Dashboard</title>
    <link rel="stylesheet" href="/dist/output.css?v=3">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-slate-300 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6 mb-12">
            <div>
                <h1 class="text-4xl font-bold text-slate-50 -tracking-wide mb-2">Spawner Registry</h1>
                <p class="text-slate-400">Real-Time Monitoring Dashboard</p>
            </div>
            <div class="flex gap-3 items-center flex-col sm:flex-row">
                <button onclick="refreshDashboard()" class="btn-primary gap-2">
                    <span>‚Üª</span>
                    <span>Refresh</span>
                </button>
                <a href="/users" class="btn-secondary gap-2">
                    <span>üë•</span>
                    <span>Users</span>
                </a>
                <div id="connectionIndicator" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500/10 text-emerald-400 rounded-lg font-semibold text-sm">
                    <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse-dot"></span>
                    <span id="connectionText">Connecting...</span>
                </div>
            </div>
        </header>

        <div class="flex justify-between items-center mb-4 text-sm">
            <div class="text-slate-400" id="lastUpdated">Last updated: Never</div>
            <div class="text-slate-500 font-mono text-xs" id="debugInfo">Waiting for data...</div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="stat-card border-t-2 border-t-blue-500">
                <div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-2">‚è±Ô∏è Uptime</div>
                <div class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent" id="uptime">0s</div>
            </div>
            <div class="stat-card border-t-2 border-t-emerald-500">
                <div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-2">üñ•Ô∏è Active Spawners</div>
                <div class="text-2xl font-bold bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent" id="activeSpawners">0</div>
            </div>
            <div class="stat-card border-t-2 border-t-blue-500">
                <div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-2">üì° Requests</div>
                <div class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent" id="totalRequests">0</div>
            </div>
            <a href="/errors" class="block">
                <div class="stat-card border-t-2 border-t-red-500 hover:bg-slate-800 transition">
                    <div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-2">‚ö†Ô∏è Errors</div>
                    <div class="text-2xl font-bold bg-gradient-to-r from-red-400 to-pink-400 bg-clip-text text-transparent" id="totalErrors">0</div>
                </div>
            </a>
            <div class="stat-card border-t-2 border-t-purple-500">
                <div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-2">üíæ Memory</div>
                <div class="text-2xl font-bold bg-gradient-to-r from-purple-400 to-indigo-400 bg-clip-text text-transparent" id="memUsage">0 B</div>
            </div>
            <div class="stat-card border-t-2 border-t-orange-500">
                <div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-2">‚¨ÜÔ∏è Tx / ‚¨áÔ∏è Rx</div>
                <div class="text-lg font-bold text-slate-100"><span id="bytesSent" class="text-orange-400">0 B</span> / <span id="bytesReceived" class="text-cyan-400">0 B</span></div>
            </div>
            <div class="stat-card border-t-2 border-t-blue-500" id="dbStatusCard">
                <div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-2">üóÑÔ∏è Database</div>
                <div class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent" id="dbStatus">Unknown</div>
            </div>
        </div>

        <!-- Spawners Section -->
        <div class="card">
            <div class="border-b border-slate-700 px-8 py-6">
                <h2 class="text-2xl font-bold text-slate-50">üì¶ Registered Spawners</h2>
            </div>

            <!-- Tabs -->
            <div class="flex overflow-x-auto border-b border-slate-700 bg-slate-800/50" id="tabsContainer">
                <button class="tab-button active" onclick="showTab('overview')">Overview</button>
            </div>

            <!-- Tab Content -->
            <div class="p-8">
                <!-- Overview Tab -->
                <div class="tab-content active" id="overview-tab">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="border-b border-slate-700">
                                <tr>
                                    <th class="text-left px-4 py-3 text-xs font-semibold text-slate-400 uppercase tracking-wider">ID</th>
                                    <th class="text-left px-4 py-3 text-xs font-semibold text-slate-400 uppercase tracking-wider">Region</th>
                                    <th class="text-left px-4 py-3 text-xs font-semibold text-slate-400 uppercase tracking-wider">Host:Port</th>
                                    <th class="text-left px-4 py-3 text-xs font-semibold text-slate-400 uppercase tracking-wider">Status</th>
                                    <th class="text-left px-4 py-3 text-xs font-semibold text-slate-400 uppercase tracking-wider">Instances</th>
                                    <th class="text-left px-4 py-3 text-xs font-semibold text-slate-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="spawnersBody">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-slate-500">Loading spawners...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Spawner Detail Tabs -->
                <div id="spawnerTabsContainer"></div>
            </div>
        </div>

        <!-- Configuration Section -->
        <div class="card mt-8">
            <div class="border-b border-slate-700 px-8 py-6">
                <h2 class="text-2xl font-bold text-slate-50">‚öôÔ∏è Configuration</h2>
            </div>
            <div class="p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="configGrid">
                    <!-- Config details -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;
        let spawnerCharts = {};
        let currentActiveTab = 'overview';
        let pollingInterval = null;

        function showTab(tabName) {
            currentActiveTab = tabName;
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            const tab = document.getElementById(tabName + '-tab');
            if (tab) tab.classList.add('active');
            event.target.classList.add('active');
            if (spawnerCharts[tabName]) {
                setTimeout(() => spawnerCharts[tabName].resize(), 0);
            }
        }

        function connectSSE() {
            if (eventSource) {
                eventSource.close();
            }

            console.log('Connecting to SSE...');
            document.getElementById('debugInfo').textContent = 'Connecting to event stream...';
            
            eventSource = new EventSource('/events');

            eventSource.onopen = () => {
                console.log('SSE connected');
                updateConnectionStatus(true, 'Live (SSE)');
                document.getElementById('debugInfo').textContent = 'Connected via SSE';
                // Stop polling if it was active
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
            };

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'stats') {
                        updateStats(data.payload);
                    } else if (data.type === 'spawners') {
                        updateSpawnersTable(data.payload);
                    }
                    updateLastUpdated();
                } catch (error) {
                    console.error('Failed to parse SSE message:', error);
                }
            };

            eventSource.onerror = (error) => {
                console.error('SSE error:', error);
                updateConnectionStatus(false, 'Reconnecting...');
                document.getElementById('debugInfo').textContent = 'SSE Error - Retrying...';
                
                // If SSE fails repeatedly, fall back to polling
                if (eventSource.readyState === EventSource.CLOSED) {
                    console.log('SSE closed, switching to polling fallback');
                    startPolling();
                }
            };
        }

        function startPolling() {
            if (pollingInterval) return; // Already polling
            
            updateConnectionStatus(true, 'Live (Polling)');
            document.getElementById('debugInfo').textContent = 'Using Polling Fallback (3s)';
            
            console.log('Starting polling...');
            refreshDashboard(); // Immediate
            pollingInterval = setInterval(refreshDashboard, 3000);
        }

        function updateConnectionStatus(connected, text) {
            const indicator = document.getElementById('connectionIndicator');
            const textEl = document.getElementById('connectionText');
            if (textEl) textEl.textContent = text;

            if (connected) {
                indicator.className = 'inline-flex items-center gap-2 px-4 py-2 bg-emerald-500/10 text-emerald-400 rounded-lg font-semibold text-sm';
                indicator.innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse-dot"></span>${text}`;
            } else {
                indicator.className = 'inline-flex items-center gap-2 px-4 py-2 bg-red-500/10 text-red-400 rounded-lg font-semibold text-sm';
                indicator.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-400"></span>${text}`;
            }
        }

        async function refreshDashboard() {
            try {
                const [statsRes, spawnersRes] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/spawners')
                ]);

                if (statsRes.ok) updateStats(await statsRes.json());
                if (spawnersRes.ok) updateSpawnersTable(await spawnersRes.json());

                updateLastUpdated();
            } catch (error) {
                console.error('Polling failed:', error);
                updateConnectionStatus(false, 'Offline');
            }
        }

        function updateStats(stats) {
            document.getElementById('uptime').textContent = formatUptime(stats.uptime);
            document.getElementById('activeSpawners').textContent = stats.active_spawners || 0;
            document.getElementById('totalRequests').textContent = stats.total_requests || 0;
            document.getElementById('totalErrors').textContent = stats.total_errors || 0;
            
            document.getElementById('memUsage').textContent = formatBytes(stats.memory_usage || 0);
            document.getElementById('bytesSent').textContent = formatBytes(stats.bytes_sent || 0);
            document.getElementById('bytesReceived').textContent = formatBytes(stats.bytes_received || 0);

            const dbStatus = stats.db_connected ? '‚úì Connected' : '‚úó Disconnected';
            document.getElementById('dbStatus').textContent = dbStatus;
            
            // Update card color based on DB status
            const dbCard = document.getElementById('dbStatusCard');
            if (stats.db_connected) {
                dbCard.className = 'stat-card border-t-2 border-t-emerald-500';
            } else {
                dbCard.className = 'stat-card border-t-2 border-t-red-500';
            }
        }

        function updateSpawnersTable(spawners) {
            const tbody = document.getElementById('spawnersBody');
            const tabsContainer = document.getElementById('tabsContainer');
            const spawnerTabsContainer = document.getElementById('spawnerTabsContainer');

            if (!spawners || spawners.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">No spawners registered yet</td></tr>';
                return;
            }

            const existingOverviewTab = document.getElementById('overview-tab');
            // Check if we need to rebuild tabs (simple check: count matches)
            const existingServerTabs = document.querySelectorAll('[id^="spawner-"][id$="-tab"]');
            const needsTabRebuild = existingServerTabs.length !== spawners.length;

            tbody.innerHTML = spawners.map(spawner => {
                const instancePercent = spawner.max_instances > 0 ? (spawner.current_instances / spawner.max_instances) * 100 : 0;
                const statusClass = spawner.status === 'active' ? 'bg-emerald-500/10 text-emerald-400' : 'bg-red-500/10 text-red-400';

                return `
                    <tr onclick="showTab('spawner-${spawner.id}')" class="border-t border-slate-700 hover:bg-slate-800/50 cursor-pointer transition">
                        <td class="px-4 py-3">${spawner.id}</td>
                        <td class="px-4 py-3 font-semibold text-slate-100">${escapeHtml(spawner.region)}</td>
                        <td class="px-4 py-3 font-mono text-slate-300">${escapeHtml(spawner.host)}:${spawner.port}</td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">
                                <span class="w-2 h-2 rounded-full bg-current"></span>
                                ${spawner.status}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm mb-2">${spawner.current_instances}/${spawner.max_instances}</div>
                            <div class="w-full h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500" style="width: ${instancePercent}%"></div>
                            </div>
                        </td>
                        <td class="px-4 py-3" onclick="event.stopPropagation()">
                            <button onclick="spawnInstance(${spawner.id})" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs font-semibold">Spawn</button>
                        </td>
                    </tr>
                `;
            }).join('');

            if (needsTabRebuild) {
                const overviewBtn = '<button class="tab-button active" onclick="showTab(\'overview\')">Overview</button>';
                const tabBtns = spawners.map(spawner => 
                    `<button class="tab-button" onclick="showTab('spawner-${spawner.id}')">${escapeHtml(spawner.region)}</button>`
                ).join('');
                tabsContainer.innerHTML = overviewBtn + tabBtns;

                spawnerTabsContainer.innerHTML = spawners.map(spawner => buildSpawnerTab(spawner)).join('');
                
                // Re-initialize charts
                spawners.forEach(spawner => setTimeout(() => initializeSpawnerChart(spawner), 100));
            } else {
                // Update existing tab content (dynamic values only)
                spawners.forEach(spawner => {
                    const tab = document.getElementById(`spawner-${spawner.id}-tab`);
                    if (tab) {
                        // Update text values here if needed, or just rebuild inner HTML lightly
                        // For simplicity, we can just update the charts
                        updateChartData(`spawner-${spawner.id}`, spawner);
                    }
                });
            }
        }

        function buildSpawnerTab(spawner) {
            const instancePercent = spawner.max_instances > 0 ? (spawner.current_instances / spawner.max_instances) * 100 : 0;
            return `
                <div class="tab-content hidden" id="spawner-${spawner.id}-tab">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-50">${escapeHtml(spawner.region)} (ID: ${spawner.id})</h3>
                        <button onclick="spawnInstance(${spawner.id})" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-semibold">Spawn New Instance</button>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                        <div class="detail-card"><div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-2">Spawner ID</div><div class="text-lg font-semibold text-slate-100">${spawner.id}</div></div>
                        <div class="detail-card"><div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-2">Host</div><div class="text-sm font-mono text-slate-100">${escapeHtml(spawner.host)}</div></div>
                        <div class="detail-card"><div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-2">Port</div><div class="text-lg font-semibold text-slate-100">${spawner.port}</div></div>
                        <div class="detail-card"><div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-2">Status</div><span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold ${spawner.status === 'active' ? 'bg-emerald-500/10 text-emerald-400' : 'bg-red-500/10 text-red-400'}"><span class="w-2 h-2 rounded-full bg-current"></span>${spawner.status}</span></div>
                        <div class="detail-card"><div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-2">Instances</div><div class="text-lg font-semibold text-slate-100">${spawner.current_instances}/${spawner.max_instances}</div></div>
                        <div class="detail-card"><div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-2">Region</div><div class="text-lg font-semibold text-slate-100">${escapeHtml(spawner.region)}</div></div>
                    </div>

                    <div class="bg-slate-700/20 border border-slate-700 rounded-lg p-6 mb-8">
                        <h4 class="text-lg font-semibold text-slate-100 mb-4">Instance Count Over Time</h4>
                        <div class="relative h-80">
                            <canvas id="chart-spawner-${spawner.id}"></canvas>
                        </div>
                    </div>
                </div>
            `;
        }

        async function spawnInstance(id) {
            if (!confirm('Are you sure?')) return;
            try {
                const response = await fetch(`/api/spawners/${id}/spawn`, { method: 'POST' });
                if (response.ok) {
                    alert('Spawn request sent!');
                    refreshDashboard();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Unknown'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function initializeSpawnerChart(spawner) {
            const canvas = document.getElementById(`chart-spawner-${spawner.id}`);
            if (!canvas) return;
            
            if (spawnerCharts[`spawner-${spawner.id}`]) {
                spawnerCharts[`spawner-${spawner.id}`].destroy();
            }

            const ctx = canvas.getContext('2d');
            spawnerCharts[`spawner-${spawner.id}`] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(30).fill(''),
                    datasets: [{
                        label: 'Instances',
                        data: Array(30).fill(spawner.current_instances),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, // Disable animation for smoother updates
                    scales: {
                        y: { beginAtZero: true, max: Math.max(10, spawner.max_instances) }
                    }
                }
            });
        }

        function updateChartData(tabName, spawner) {
            const chart = spawnerCharts[tabName];
            if (!chart) return;

            chart.data.labels.push(new Date().toLocaleTimeString());
            chart.data.labels.shift();
            chart.data.datasets[0].data.push(spawner.current_instances);
            chart.data.datasets[0].data.shift();
            chart.update('none'); // Update mode 'none' for performance
        }

        function formatUptime(ms) {
            if (!ms) return '0s';
            const s = Math.floor(ms / 1000);
            const m = Math.floor(s / 60);
            const h = Math.floor(m / 60);
            return `${h}h ${m % 60}m ${s % 60}s`;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = `Last updated: ${now.toLocaleTimeString()}`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/[&<>"]/g, function(m) {
                return {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;'}[m];
            });
        }

        // Start
        connectSSE();
    </script>
</body>
</html>